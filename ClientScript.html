<script>
document.addEventListener('DOMContentLoaded', () => {
  const appState = { currentUser: null, currentView: 'dashboard', projects: [] };
  const mainContent = document.getElementById('main-content');
  const navLinks = document.querySelectorAll('.nav-link');
  const views = document.querySelectorAll('.view');

  function timeAgo(dtStr) {
    if (!dtStr) return '-';
    const d = new Date(dtStr);
    if (isNaN(d)) return '-';
    const diffMs = Date.now() - d.getTime();
    const sec = Math.floor(diffMs / 1000);
    if (sec < 2) return 'just now';
    if (sec < 60) return `${sec}s ago`;
    const min = Math.floor(sec / 60);
    if (min < 60) return `${min}m ago`;
    const hr = Math.floor(min / 60);
    if (hr < 24) return `${hr}h ago`;
    const day = Math.floor(hr / 24);
    if (day === 1) return 'Yesterday';
    return `${day}d ago`;
  }

  function showError(element, message) {
    if(element) element.innerHTML = `<div class="p-6 text-center text-red-600"><h2>Error</h2><p>${message}</p></div>`;
  }

  function callServer(fnName, payload) {
    return new Promise((resolve, reject) => {
      google.script.run.withSuccessHandler(resolve).withFailureHandler(reject)[fnName](payload);
    });
  }

  function navigateTo(viewId) {
    views.forEach(v => v.classList.remove('active'));
    const target = document.getElementById(viewId);
    if (target) target.classList.add('active');
    appState.currentView = viewId;
    navLinks.forEach(link => {
      const isActive = link.getAttribute('href') === `#${viewId}`;
      link.classList.toggle('bg-indigo-50', isActive);
      link.classList.toggle('text-indigo-700', isActive);
    });
    loadDataForView(viewId);
  }

  function toggleProjectSubView(showChat) {
      const listView = document.getElementById('project-list-view');
      const chatView = document.getElementById('project-chat-view');
      if(listView && chatView) {
          listView.style.display = showChat ? 'none' : 'flex';
          chatView.style.display = showChat ? 'flex' : 'none';
      }
  }

  function loadDataForView(viewId) {
    if (viewId === 'project-management') {
      toggleProjectSubView(false); // Default to list view
      loadProjectManagementData();
    }
    // Add cases for other views like 'knowledge-base', 'settings' here
  }

  async function loadProjectManagementData() {
    const container = document.getElementById('project-list-container');
    if (!container) return;
    container.innerHTML = `<tr><td colspan="4" class="text-center p-6 text-slate-500 animate-pulse">Loading...</td></tr>`;
    try {
      const projects = await callServer('getProjectList');
      appState.projects = projects || [];
      if (appState.projects.length > 0) {
        appState.projects.sort((a, b) => new Date(b.Last_Activity_At) - new Date(a.Last_Activity_At));
        container.innerHTML = appState.projects.map(p => `
          <tr class="bg-white border-b hover:bg-slate-50">
            <th class="px-6 py-4 font-medium text-slate-900">${p.Project_Name}</th>
            <td class="px-6 py-4">${p.Created_By_User_ID}</td>
            <td class="px-6 py-4">${timeAgo(p.Last_Activity_At)}</td>
            <td class="px-6 py-4 text-right">
              <button class="font-medium text-indigo-600 hover:underline open-project-btn" data-project-id="${p.Project_ID}" data-project-name="${p.Project_Name}">Open</button>
            </td>
          </tr>
        `).join('');
      } else {
        container.innerHTML = `<tr><td colspan="4" class="text-center p-6 text-slate-500">No projects found.</td></tr>`;
      }
    } catch (err) {
      container.innerHTML = `<tr><td colspan="4" class="text-center p-6 text-red-500">Error: ${err.message}</td></tr>`;
    }
  }

  function initApp() {
    // --- EVENT LISTENERS ---
    navLinks.forEach(link => {
      link.addEventListener('click', (e) => {
        e.preventDefault();
        navigateTo(link.getAttribute('href').substring(1));
      });
    });

    document.addEventListener('click', (e) => {
        // Handle opening a project chat
        if (e.target.classList.contains('open-project-btn')) {
            const projectId = e.target.dataset.projectId;
            const projectName = e.target.dataset.projectName;
            document.getElementById('chat-project-name').textContent = `Project: ${projectName}`;
            toggleProjectSubView(true);
            // Future: loadChatHistory(projectId);
        }
        // Handle going back to the project list
        if (e.target.classList.contains('back-to-list-btn')) {
            toggleProjectSubView(false);
        }
    });

    const newProjectBtn = document.getElementById('new-project-btn');
    if (newProjectBtn) {
      newProjectBtn.addEventListener('click', async () => {
        const projectName = prompt("Enter project name:");
        if (projectName && projectName.trim() !== "") {
          try {
            await callServer('createNewProject', projectName.trim());
            loadProjectManagementData();
          } catch (err) { alert(`Error: ${err.message}`); }
        }
      });
    }

    // --- INITIAL LOAD ---
    google.script.run
      .withSuccessHandler(user => {
        if (user && user.Display_Name) {
          appState.currentUser = user;
          document.getElementById('user-display-name').textContent = `by ${user.Display_Name}`;
          document.getElementById('user-profile-name').textContent = user.Display_Name;
          document.getElementById('user-profile-email').textContent = user.User_ID;
          navigateTo('project-chat');
        } else { showError(mainContent, "Failed to retrieve user data."); }
      })
      .withFailureHandler(err => { showError(mainContent, `Could not load profile. Error: ${err.message}`); })
      .getUserProfile();
  }

  initApp();
});
</script>